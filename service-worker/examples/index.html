<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snapkit Service Worker - Cloudinary Style</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .status {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.active {
      background: #10b981;
      box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-indicator.inactive {
      background: #ef4444;
    }

    .section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .config-display {
      background: #f0f9ff;
      border: 2px solid #0ea5e9;
      border-radius: 8px;
      padding: 20px;
      margin-top: 15px;
    }

    .config-display h4 {
      color: #0c4a6e;
      margin-bottom: 10px;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #bae6fd;
    }

    .config-item:last-child {
      border-bottom: none;
    }

    .config-label {
      font-weight: 500;
      color: #075985;
    }

    .config-value {
      font-family: 'Courier New', monospace;
      color: #0369a1;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .image-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .image-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .image-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .image-info {
      padding: 15px;
      background: #f9fafb;
    }

    .image-info h4 {
      color: #333;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .image-info p {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 8px;
    }

    .badge.optimized {
      background: #d1fae5;
      color: #065f46;
    }

    code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      color: #be185d;
    }

    .note {
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
    }

    .note strong {
      color: #92400e;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background 0.2s;
      margin-right: 10px;
      margin-top: 10px;
    }

    button:hover {
      background: #5568d3;
    }

    button.danger {
      background: #ef4444;
    }

    button.danger:hover {
      background: #dc2626;
    }

    #url-log {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      margin-top: 15px;
    }

    #url-log div {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #334155;
    }

    #url-log .original {
      color: #fbbf24;
    }

    #url-log .transformed {
      color: #34d399;
    }

    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>üöÄ Snapkit Service Worker</h1>
    <p class="subtitle">Cloudinary-style configuration with clientMetrics</p>
  </header>

  <div class="status">
    <h2 style="font-size: 1.2rem; margin-bottom: 10px;">
      <span class="status-indicator" id="sw-status"></span>
      Service Worker Status
    </h2>
    <p id="sw-status-text">Checking...</p>
  </div>

  <div class="section">
    <h2>Cloudinary-Style Configuration</h2>
    <p>
      This demo uses Cloudinary's Service Worker approach with clientMetrics (viewport width and DPR).
    </p>

    <div class="config-display">
      <h4>üìä Current Configuration</h4>
      <div class="config-item">
        <span class="config-label">Viewport Width:</span>
        <span class="config-value" id="viewport-width">-</span>
      </div>
      <div class="config-item">
        <span class="config-label">Device Pixel Ratio:</span>
        <span class="config-value" id="dpr">-</span>
      </div>
      <div class="config-item">
        <span class="config-label">Organization:</span>
        <span class="config-value">demo</span>
      </div>
      <div class="config-item">
        <span class="config-label">Quality:</span>
        <span class="config-value">auto ‚Üí 85</span>
      </div>
      <div class="config-item">
        <span class="config-label">Format:</span>
        <span class="config-value">auto ‚Üí webp</span>
      </div>
      <div class="config-item">
        <span class="config-label">Limit Max Width:</span>
        <span class="config-value">true</span>
      </div>
    </div>

    <h3 style="margin-top: 20px;">Registration Code:</h3>
    <pre><code>const config = {
  clientMetrics: {
    viewportWidth: window.innerWidth,     // <span id="actual-viewport">1920</span>
    dpr: window.devicePixelRatio || 1,    // <span id="actual-dpr">2</span>
    enabled: true,
  },
  delivery: {
    organizationName: 'demo'
  },
  optimization: {
    quality: 'auto',      // ‚Üí 85
    format: 'auto',       // ‚Üí webp
    limitMaxWidth: true,  // Max width = viewport
  }
};

// Cloudinary-style registration
registerSnapkitServiceWorker(config, 'url');</code></pre>
  </div>

  <div class="section">
    <h2>Example Images</h2>
    <p>All images are automatically optimized with viewport-aware sizing:</p>

    <div class="image-grid">
      <div class="image-card">
        <img src="https://picsum.photos/800/600?random=1" alt="Random 1">
        <div class="image-info">
          <h4>Random Photo 1</h4>
          <p>Max width limited to viewport</p>
          <span class="badge optimized">‚úì Auto-optimized</span>
        </div>
      </div>

      <div class="image-card">
        <img src="https://picsum.photos/800/600?random=2" alt="Random 2">
        <div class="image-info">
          <h4>Random Photo 2</h4>
          <p>WebP format + Quality 85</p>
          <span class="badge optimized">‚úì Auto-optimized</span>
        </div>
      </div>

      <div class="image-card">
        <img src="https://picsum.photos/800/600?random=3" alt="Random 3">
        <div class="image-info">
          <h4>Random Photo 3</h4>
          <p>DPR applied for retina</p>
          <span class="badge optimized">‚úì Auto-optimized</span>
        </div>
      </div>

      <div class="image-card">
        <img src="https://picsum.photos/800/600?random=4" alt="Random 4">
        <div class="image-info">
          <h4>Random Photo 4</h4>
          <p>Cloudinary-style config</p>
          <span class="badge optimized">‚úì Auto-optimized</span>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>URL Transformation Log</h2>
    <p>Watch clientMetrics in action:</p>
    <div id="url-log">
      <div style="color: #94a3b8;">Waiting for image requests...</div>
    </div>
  </div>

  <div class="section">
    <h2>Controls</h2>
    <button onclick="window.location.reload()">üîÑ Reload Page</button>
    <button onclick="unregisterSW()" class="danger">‚ùå Unregister SW</button>
  </div>

  <div class="note">
    <strong>üí° Tip:</strong> Resize your browser window and reload to see viewport-aware optimization in action!
  </div>

  <script src="../register-sw.js"></script>
  <script>
    // Display actual metrics
    document.getElementById('viewport-width').textContent = window.innerWidth + 'px';
    document.getElementById('dpr').textContent = (window.devicePixelRatio || 1);
    document.getElementById('actual-viewport').textContent = window.innerWidth;
    document.getElementById('actual-dpr').textContent = (window.devicePixelRatio || 1);

    const urlLog = document.getElementById('url-log');
    let logEntries = [];

    // Log transformations
    function logTransformation(original, transformed) {
      const entry = document.createElement('div');
      entry.innerHTML = `
        <div class="original">‚ñ∏ ${original}</div>
        <div class="transformed">‚úì ${transformed}</div>
      `;
      logEntries.unshift(entry);

      if (logEntries.length > 10) logEntries.pop();

      urlLog.innerHTML = '';
      logEntries.forEach(e => urlLog.appendChild(e));
    }

    // Cloudinary-style configuration
    const snapkitConfig = {
      clientMetrics: {
        viewportWidth: window.innerWidth,
        dpr: window.devicePixelRatio || 1,
        enabled: true,
      },
      delivery: {
        organizationName: 'demo',
      },
      optimization: {
        quality: 'auto',
        format: 'auto',
        limitMaxWidth: true,
      },
    };

    // Register with Cloudinary-style URL parameter
    registerSnapkitServiceWorker(snapkitConfig, 'url')
      .then(() => {
        updateStatus(true, 'Service Worker active with clientMetrics!');
      })
      .catch((error) => {
        updateStatus(false, `Failed: ${error.message}`);
      });

    // Update status
    function updateStatus(active, message) {
      const indicator = document.getElementById('sw-status');
      const text = document.getElementById('sw-status-text');
      indicator.className = 'status-indicator ' + (active ? 'active' : 'inactive');
      text.textContent = message;
    }

    // Check initial status
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistration().then((reg) => {
        if (reg) {
          updateStatus(true, 'Service Worker running');
        } else {
          updateStatus(false, 'Not registered yet');
        }
      });
    } else {
      updateStatus(false, 'Service Workers not supported');
    }

    // Monitor network requests
    if ('PerformanceObserver' in window) {
      const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach((entry) => {
          if (entry.initiatorType === 'img') {
            const url = entry.name;
            if (url.includes('snapkit.dev')) {
              const urlObj = new URL(url);
              const originalUrl = urlObj.searchParams.get('url');
              if (originalUrl) {
                logTransformation(originalUrl, url);
              }
            }
          }
        });
      });
      observer.observe({ entryTypes: ['resource'] });
    }

    // Unregister
    async function unregisterSW() {
      if (confirm('Unregister Service Worker?')) {
        await unregisterSnapkitServiceWorker();
        updateStatus(false, 'Unregistered - Reload to see original images');
      }
    }
  </script>
</body>
</html>
